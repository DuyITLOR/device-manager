// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}



enum UserRole {
  USER
  MANAGER
  ADMIN
}



enum DeviceStatus {
  AVAILABLE
  BORROWED
  MAINTENANCE
}

enum LoanStatus {
  BORROWED
  RETURNED
}

enum TransferStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELED
}

enum ActivityTargetType {
  Loan
  Transfer
  Device
  User
}

enum ActivityAction {
  LOAN_CREATE
  LOAN_RETURN
  TRANSFER_REQUEST
  TRANSFER_APPROVE
  TRANSFER_REJECT
  TRANSFER_CANCEL
  DEVICE_CREATE
  DEVICE_UPDATE
  AUTH_LOGIN
  AUTH_LOGOUT
}



model User {
  id        String   @id @default(uuid())
  code      String
  name      String
  email     String   @unique
  password  String
  role      UserRole
  createdAt DateTime @default(now())

  loansBorrowed   Loan[]        @relation("LoansByBorrower")
  transfersFrom   Transfer[]    @relation("TransfersFromUser")
  transfersTo     Transfer[]    @relation("TransfersToUser")
  activityLogs    ActivityLog[] @relation("ActivityActor")

}

model Device {
  id          String   @id
  name        String
  description String
  status      DeviceStatus
  createdAt   DateTime @default(now())

  loans Loan[]

  @@index([status])
}

model Loan {
  id         String   @id @default(uuid())
  deviceId   String
  borrowerId String
  status     LoanStatus
  borrowedAt DateTime @default(now())
  returnedAt DateTime?
  note       String


  device     Device   @relation(fields: [deviceId], references: [id], onDelete: Restrict)
  borrower   User     @relation("LoansByBorrower", fields: [borrowerId], references: [id], onDelete: Restrict)

  transfers  Transfer[]

  @@index([deviceId])
  @@index([borrowerId])
  @@index([status])
}


model Transfer {
  id          String   @id @default(uuid())
  loanId      String
  fromUserId  String
  toUserId    String
  status      TransferStatus
  requestedAt DateTime @default(now())


  loan     Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)
  fromUser User @relation("TransfersFromUser", fields: [fromUserId], references: [id], onDelete: Restrict)
  toUser   User @relation("TransfersToUser", fields: [toUserId], references: [id], onDelete: Restrict)

  @@index([loanId])
  @@index([fromUserId])
  @@index([toUserId])
  @@index([status])
}

model ActivityLog {
  id         String   @id @default(uuid())
  actorId    String?
  action     ActivityAction
  targetType ActivityTargetType
  targetId   String
  timestamp  DateTime @default(now())    
  details    Json

  actor      User? @relation("ActivityActor", fields: [actorId], references: [id], onDelete: SetNull)

  @@index([actorId])
  @@index([targetType, targetId])
  @@index([timestamp])
}
